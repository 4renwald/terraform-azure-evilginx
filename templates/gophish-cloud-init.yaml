#cloud-config
package_update: true
package_upgrade: true

packages:
  - git
  - gcc
  - curl
  - jq
  - ca-certificates
  - openssl

write_files:
  - path: /opt/gophish/config.json
    permissions: "0640"
    content: |
      {
        "admin_server": {
          "listen_url": "0.0.0.0:3333",
          "use_tls": true,
          "cert_path": "gophish_admin.crt",
          "key_path": "gophish_admin.key"
        },
        "phish_server": {
          "listen_url": "0.0.0.0:80",
          "use_tls": false,
          "cert_path": "example.crt",
          "key_path": "example.key"
        },
        "db_name": "sqlite3",
        "db_path": "gophish.db",
        "migrations_prefix": "db/db_",
        "contact_address": "",
        "logging": {
          "filename": "",
          "level": ""
        }
      }

  - path: /etc/systemd/system/gophish.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Gophish Phishing Campaign Manager
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      ExecStart=/opt/gophish/gophish
      WorkingDirectory=/opt/gophish
      Restart=on-failure
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

runcmd:
  # Ensure hostname resolves locally (prevents sudo warning noise)
  - grep -q "$(hostname)" /etc/hosts || echo "127.0.1.1 $(hostname)" >> /etc/hosts

  # Install Go, clone, build, and start Gophish â€” all in one shell
  # (export/cd must persist, so a single script block is required)
  - |
    set -euo pipefail

    GO_VERSION="${go_version}"
    GO_SHA256="${go_linux_amd64_tarball_sha256}"

    # Install pinned Go release with checksum verification.
    curl -fsSL "https://go.dev/dl/go$${GO_VERSION}.linux-amd64.tar.gz" -o /tmp/go.tar.gz
    echo "$${GO_SHA256}  /tmp/go.tar.gz" | sha256sum -c -
    tar -C /usr/local -xzf /tmp/go.tar.gz
    rm -f /tmp/go.tar.gz
    export HOME=/root
    export PATH=$PATH:/usr/local/go/bin:/root/go/bin
    export GOPATH=/root/go
    export XDG_CACHE_HOME=/root/.cache
    export GOCACHE=/root/.cache/go-build
    mkdir -p "$GOPATH" "$GOCACHE"
    echo 'export PATH=$PATH:/usr/local/go/bin:/root/go/bin' >> /etc/profile.d/golang.sh

    # Clone and build the kgretzky fork of Gophish (required for Evilginx integration)
    git clone https://github.com/kgretzky/gophish.git /opt/gophish-src
    cd /opt/gophish-src
    git -c advice.detachedHead=false checkout -- "${gophish_repo_ref}"
    mkdir -p /opt/gophish
    go build -o /opt/gophish/gophish .

    # Generate a self-signed TLS certificate for the admin panel
    openssl req -newkey rsa:2048 -nodes \
      -keyout /opt/gophish/gophish_admin.key \
      -x509 -days 365 \
      -out /opt/gophish/gophish_admin.crt \
      -subj "/CN=gophish-admin"
    chmod 640 /opt/gophish/gophish_admin.key /opt/gophish/gophish_admin.crt

    # Copy static assets from the source build
    cp -r /opt/gophish-src/static /opt/gophish/
    cp -r /opt/gophish-src/templates /opt/gophish/
    cp -r /opt/gophish-src/db /opt/gophish/

    # Enable and start Gophish service
    systemctl daemon-reload
    systemctl enable gophish.service
    systemctl start gophish.service
